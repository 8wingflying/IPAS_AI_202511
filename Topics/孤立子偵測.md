##

## 資料集
- [Outlier Detection DataSets](https://shebuti.com/outlier-detection-datasets-odds/)
- [ADBenchmarks: Real-world anomaly detection datasets](https://github.com/mala-lab/ADBenchmarks-anomaly-detection-datasets)
- [Evaluation of Datasets for Outlier Detection](https://www.researchgate.net/publication/384334491_Evaluation_of_Datasets_for_Outlier_Detection)

## 孤立子|離群值偵測 Outlier Detection 

```python
# =======================================
# 📘 離群值偵測 Outlier Detection 實作示範
# =======================================

import numpy as np
import pandas as pd
from sklearn.ensemble import IsolationForest
from sklearn.neighbors import LocalOutlierFactor
from scipy import stats
import matplotlib.pyplot as plt
import seaborn as sns

# 建立範例資料（包含離群點）
np.random.seed(42)
normal_data = np.random.normal(50, 5, 100)
outliers = np.array([20, 120, 150])  # 明顯異常值
data = np.concatenate([normal_data, outliers])
df = pd.DataFrame({'value': data})

# ==========================
# 1️⃣ Z-score 離群值偵測
# ==========================
df['z_score'] = stats.zscore(df['value'])
df['z_outlier'] = np.where(np.abs(df['z_score']) > 3, 1, 0)

print("Z-score 偵測結果：")
print(df[df['z_outlier'] == 1])

# ==========================
# 2️⃣ IQR 離群值偵測
# ==========================
Q1 = df['value'].quantile(0.25)
Q3 = df['value'].quantile(0.75)
IQR = Q3 - Q1
lower, upper = Q1 - 1.5*IQR, Q3 + 1.5*IQR

df['iqr_outlier'] = np.where((df['value'] < lower) | (df['value'] > upper), 1, 0)
print("\nIQR 偵測結果：")
print(df[df['iqr_outlier'] == 1])

# ==========================
# 3️⃣ Isolation Forest
# ==========================
iso = IsolationForest(contamination=0.03, random_state=42)
df['iso_outlier'] = iso.fit_predict(df[['value']])
df['iso_outlier'] = df['iso_outlier'].map({1:0, -1:1})

print("\nIsolation Forest 偵測結果：")
print(df[df['iso_outlier'] == 1])

# ==========================
# 4️⃣ Local Outlier Factor (LOF)
# ==========================
lof = LocalOutlierFactor(n_neighbors=20, contamination=0.03)
df['lof_outlier'] = lof.fit_predict(df[['value']])
df['lof_outlier'] = df['lof_outlier'].map({1:0, -1:1})

print("\nLOF 偵測結果：")
print(df[df['lof_outlier'] == 1])

# ==========================
# 5️⃣ 視覺化 Boxplot
# ==========================
plt.figure(figsize=(8,4))
sns.boxplot(df['value'])
plt.title("Boxplot 離群值視覺化")
plt.show()

```
## KNN 離群值偵測(使用pyod套件)
```python
# ============================
# 📘 KNN 離群值偵測範例
# ============================
import numpy as np
import matplotlib.pyplot as plt
from pyod.models.knn import KNN  # pip install pyod

# 建立資料集
X_inliers = 0.3 * np.random.randn(100, 2)
X_outliers = np.random.uniform(low=-4, high=4, size=(5, 2))
X = np.r_[X_inliers + 2, X_inliers - 2, X_outliers]

# 建立 KNN 模型
knn = KNN(contamination=0.05)  # 假設離群值比例 5%
knn.fit(X)

# 預測
y_pred = knn.labels_            # 0 = 正常, 1 = 離群
y_scores = knn.decision_scores_ # 離群分數

# 視覺化結果
plt.figure(figsize=(6,6))
plt.scatter(X[:,0], X[:,1], c=y_pred, cmap='coolwarm', s=50)
plt.title("KNN Outlier Detection Example")
plt.xlabel("Feature 1")
plt.ylabel("Feature 2")
plt.show()

```
## KNN 離群值偵測(使用Scikit-learn)
- 
```python
from sklearn.neighbors import LocalOutlierFactor

lof = LocalOutlierFactor(n_neighbors=5, contamination=0.05)
y_pred = lof.fit_predict(X)

plt.figure(figsize=(6,6))
plt.scatter(X[:,0], X[:,1], c=y_pred, cmap='coolwarm', s=50)
plt.title("Local Outlier Factor (基於KNN的離群偵測)")
plt.show()
```
## Credit Card Fraud Detection
- 🎯 目標：使用 Isolation Forest 與 LOF 偵測詐欺交易
```python

# =======================================
# Kaggle: Credit Card Fraud Detection
# =======================================

import pandas as pd
import numpy as np
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import IsolationForest
from sklearn.neighbors import LocalOutlierFactor
from sklearn.metrics import classification_report, confusion_matrix

# 1️⃣ 讀取資料
df = pd.read_csv("creditcard.csv")

# 2️⃣ 前處理
features = df.drop(columns=["Class"])
labels = df["Class"]  # 0=正常, 1=詐欺
scaler = StandardScaler()
X = scaler.fit_transform(features)

# 3️⃣ 使用 Isolation Forest
iso = IsolationForest(contamination=0.0017, random_state=42)
y_pred_iso = iso.fit_predict(X)
y_pred_iso = np.where(y_pred_iso == -1, 1, 0)  # 1代表異常

print("🔹 Isolation Forest 結果")
print(confusion_matrix(labels, y_pred_iso))
print(classification_report(labels, y_pred_iso))

# 4️⃣ 使用 LOF
lof = LocalOutlierFactor(n_neighbors=20, contamination=0.0017)
y_pred_lof = lof.fit_predict(X)
y_pred_lof = np.where(y_pred_lof == -1, 1, 0)

print("\n🔹 Local Outlier Factor 結果")
print(confusion_matrix(labels, y_pred_lof))
print(classification_report(labels, y_pred_lof))

```


## Paysim 模擬金融異常交易
- 🎯 目標：利用 KNN 與 IQR 偵測模擬金融交易異常
```python
# =======================================
# Kaggle: Paysim 模擬金融交易資料
# =======================================
import pandas as pd
from pyod.models.knn import KNN
from sklearn.preprocessing import MinMaxScaler

# 1️⃣ 讀入資料
data = pd.read_csv("PS_20174392719_1491204439457_log.csv")
df = data.sample(50000)  # 抽樣以加快運算

# 2️⃣ 選擇部分數值特徵
X = df[['amount', 'oldbalanceOrg', 'newbalanceOrig']]
X_scaled = MinMaxScaler().fit_transform(X)

# 3️⃣ 建立 KNN 模型
knn = KNN(contamination=0.01)
knn.fit(X_scaled)
df['outlier'] = knn.labels_

# 4️⃣ 結果檢視
print(df['outlier'].value_counts())
print(df[df['outlier'] == 1].head())

# 5️⃣ 視覺化
import matplotlib.pyplot as plt
plt.scatter(df['oldbalanceOrg'], df['amount'], c=df['outlier'], cmap='coolwarm', s=5)
plt.xlabel("Old Balance")
plt.ylabel("Amount")
plt.title("KNN Outlier Detection - Paysim")
plt.show()
```
## Data Cleaning Challenge: Outliers
- 🎯 目標：使用 IQR 法 + Boxplot 找出報銷資料中的離群點
```python
# =======================================
# Kaggle: Data Cleaning Challenge - Outliers
# =======================================
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

# 1️⃣ 載入資料
df = pd.read_csv("brasilian_public_expenses.csv")  # Kaggle Notebook 範例資料
print(df.describe())

# 2️⃣ IQR 計算
Q1 = df['reimbursement_value'].quantile(0.25)
Q3 = df['reimbursement_value'].quantile(0.75)
IQR = Q3 - Q1
upper = Q3 + 1.5 * IQR

# 3️⃣ 找出離群值
outliers = df[df['reimbursement_value'] > upper]
print(f"離群樣本數：{len(outliers)}")

# 4️⃣ Boxplot 視覺化
plt.figure(figsize=(8,4))
sns.boxplot(x=df['reimbursement_value'])
plt.title("Outlier Detection by IQR (Reimbursement Value)")
plt.show()
```
